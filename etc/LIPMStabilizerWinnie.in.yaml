Managed: false
StepByStep: false
IdleKeepState: true

StatesLibraries:
- "@MC_STATES_DEFAULT_RUNTIME_INSTALL_PREFIX@"
- "@MC_STATES_RUNTIME_INSTALL_PREFIX@"
StatesFiles:
- "@MC_STATES_DEFAULT_RUNTIME_INSTALL_PREFIX@/data"
- "@MC_STATES_RUNTIME_INSTALL_PREFIX@/data"
VerboseStateFactory: false

Plugins: [MosquittoPlugin]

# Additional robots to load
robots:
  ground:
    module: env/ground
# General constraints, always on
constraints:
- type: contact
- type: kinematics
  damper: [0.1, 0.01, 0.5]
- type: compoundJoint
# Collision constraint
collisions:
- type: collision
  useCommon: true
# Initial set of contacts
contacts: []

# Implement some additional text states
states:
  LookAtRightHand:
    base: MetaTasks
    tasks:
      LookAt:
        type: lookAtFrame
        frame: NECK_P_LINK
        frameVector: [1, 0, 0]
        target:
          robot: hrp4
          frame: r_wrist
        weight: 500
        stiffness: 10

  LookAtLeftHand:
    base: MetaTasks
    tasks:
      LookAt:
        type: lookAtFrame
        frame: NECK_P_LINK
        frameVector: [1, 0, 0]
        target:
          robot: hrp4
          frame: l_wrist
        weight: 500
        stiffness: 10

  LookAtAudience:
    base: MetaTasks
    tasks:
      LookAt:
        type: lookAt
        frame: NECK_P_LINK
        frameVector: [1, 0, 0]
        targetVector: [1, 0, 0]
        weight: 500
        stiffness: 10

  PostureBase:
    base: Posture
    postureTask:
      type: posture
      stiffness: 5.0
      weight: 100.0
    completion:
      OR:
        - timeout: 3.0
        - AND:
          - eval: 0.01
          - speed: 0.01

  TouchHead:
    base: PostureBase
    postureTask:
      target:
        # NECK_P: [0.8]
        # NECK_Y: [1.2]
        R_SHOULDER_R: [-0.6]
        R_SHOULDER_P: [-2.5] #-2.0
        R_SHOULDER_Y: [1.6] #-3.1
        R_ELBOW_P: [-2.1]
        # L_SHOULDER_R: [2.15]

  TouchHead_L:
    base: PostureBase
    postureTask:
      target:
        # NECK_P: [0.8]
        # NECK_Y: [1.2]
        L_SHOULDER_R: [1.235]
        L_SHOULDER_P: [-1.9] #-2.0
        # L_SHOULDER_Y: [1.6] #-3.1
        L_ELBOW_P: [-2.12]
        # L_SHOULDER_R: [2.15]

  RaiseRightHand_v2:
    base: MetaTasks
    tasks:
      LeftHandTrajectory:
        type: bspline_trajectory
        setupMode: false
        frame: r_gripper
        weight: 100
        stiffness: 50
        duration: 4
        dimWeight: [1,1,1, 1, 0.5, 0.5]
        displaySamples: 100
        target:
          translation: [0.4, -0.5, 1.1]
          rotation: [0, 0, 0]
        controlPoints: [[0.57, 0.5, 0.85]]
        # oriWaypoints: [[3.5, [-1.57,  0, 1.57]]]
        completion:
          timeElapsed: true

  RaiseRightHand:
    base: LookAtRightHand
    tasks:
      LeftHandTrajectory:
        type: bspline_trajectory
        setupMode: false
        frame: r_gripper
        weight: 100
        stiffness: 50
        duration: 4
        dimWeight: [1,1,1, 1, 0.5, 0.5]
        displaySamples: 100
        target:
          translation: [0.5, -0.3, 1.1]
          rotation: [0, 0, 0]
        controlPoints: [[0.57, 0.5, 0.85]]
        # oriWaypoints: [[3.5, [-1.57,  0, 1.57]]]
        completion:
          timeElapsed: true

  RaiseLeftHand:
    base: MetaTasks
    tasks:
      LeftHandTrajectory:
        type: bspline_trajectory
        setupMode: false
        frame: l_gripper
        weight: 100
        stiffness: 50
        duration: 4
        dimWeight: [1,1,1, 1, 0.5, 0.5]
        displaySamples: 100
        target:
          translation: [-0.5, 0.3, 0.5]
          rotation: [0, 0, 0]
        controlPoints: [[0.57, 0.5, 0.85]]
        # oriWaypoints: [[3.5, [-1.57,  0, 1.57]]]
        completion:
          timeElapsed: true

  RightHandBackground:
    base: LookAtRightHand
    tasks:
      LeftHandTrajectory:
        type: bspline_trajectory
        setupMode: false
        frame: r_gripper
        weight: 100
        stiffness: 50
        duration: 4
        dimWeight: [1,1, 1, 1, 0.5, 0.5]
        displaySamples: 100
        target:
          # Rotation expressed as RPY (in radian)
          # May also be expressed as quaternion or rotation matrix
          translation: [0.6, -0.3, 1.1]
          rotation: [0, 0, 0]
        controlPoints: [[0.0, 0.15, 0.85]]
        # oriWaypoints: [[3.5, [-1.57,  0, 1.57]]]
        completion:
          timeElapsed: true

  DrawCircleRightHand:
    base: MetaTasks
    tasks:
      LeftHandTrajectory:
        type: bspline_trajectory
        setupMode: false
        frame: r_gripper
        weight: 100
        stiffness: 50
        duration: 4
        dimWeight: [1,1,1, 1, 0.5, 0.5]
        displaySamples: 100
        target:
          translation: [0.7, 0.0, 0.8]
          rotation: [0, 0, 0]
        controlPoints: [[0.27, 0.4, 0.85]]
        # oriWaypoints: [[3.5, [-1.57,  0, 1.57]]]
        completion:
          timeElapsed: true

  DrawCircleLeftHand:
    base: MetaTasks
    tasks:
      LeftHandTrajectory:
        type: bspline_trajectory
        setupMode: false
        frame: l_gripper
        weight: 100
        stiffness: 50
        duration: 4
        dimWeight: [1,1,1, 1, 0.5, 0.5]
        displaySamples: 100
        target:
          translation: [0.7, 0.0, 0.5]
          rotation: [0, 0, 0]
        controlPoints: [[0.37, 0.2, 0.85]]
        # oriWaypoints: [[3.5, [-1.57,  0, 1.57]]]
        completion:
          timeElapsed: true

  PutDownRightShoulder:
    base: PostureBase
    postureTask:
      target:
        R_SHOULDER_P: [-0.167]
        R_SHOULDER_R: [-0.31]
        R_SHOULDER_Y: [0.02]
        R_ELBOW_P: [-0.18]
        R_WRIST_R: [0.08]

  LeftHeadTilt:
    base: PostureBase
    postureTask:
      target:
        NECK_P: [0.7]
        # NECK_Y: [0.5]
        # L_SHOULDER_R: [2.15]

  RightHeadTilt:
    base: PostureBase
    postureTask:
      target:
        NECK_P: [0.0]
        # NECK_Y: [-0.1]
        # L_SHOULDER_R: [2.15]

  Dance::ConditionBaseMovement:
    base: AutonomousInteraction

  Salutations:
    base: InterpolatePosture
    hrp4:
      scaleTime: 1.0
      posture_task:
        stiffness: 200
      posture_sequence:
        - time: 5.0
          posture: {}
          comOffset: [0, 0, -0.2]
        - time: 5.0
          posture:
            R_SHOULDER_R: -0.662
            R_SHOULDER_Y: -0.52
            L_SHOULDER_R: 0.617
            L_SHOULDER_Y: 0.356
          comOffset: [0, 0, -0.2]
        - time: 5.0
          posture:
            R_SHOULDER_R: -0.206
            R_SHOULDER_Y: 0.156
            L_SHOULDER_R: 0.162
            L_SHOULDER_Y: 0.082
            R_ELBOW_P: -1.329
            L_ELBOW_P: -1.2679
          comOffset: [0, 0, -0.2]
        - time: 5.0
          posture:
            R_SHOULDER_R: -0.438
            L_SHOULDER_R: 0.405
            NECK_Y: 0.946
          comOffset: [0, 0, -0.2]
        - time: 5.0
          posture:
            NECK_Y: -1.02
          comOffset: [0, 0, -0.2]
        - time: 5.0
          posture:
            NECK_P: 0.607
          comOffset: [0, 0, -0.2]
        - time: 5.0
          posture:
            NECK_P: -0.607
          # shake:
          #   NECK_P:
          #     period: 10 # [s]
          #     amplitude: 0.2 # rad
          comOffset: [0, 0, -0.2]
        - time: 5.0
          posture:
            R_SHOULDER_P: -1.375
            R_WRIST_Y: 1.284
            R_ELBOW_P: -1.415
        - time: 5.0
          posture: 
            NECK_P: 0.82
            shake:
            NECK_P:
              period: 8 # [s]
              amplitude: 0.2 # rad
        - time: 5.0
          posture: 
            R_SHOULDER_P: -0.227
            R_ELBOW_P: -0.586
        - time: 5.0
          posture:
            NECK_Y: 0.608
            NECK_P: -0.384
            L_SHOULDER_P: -1.412
            L_ELBOW_P: -1.688
            shake:
            L_SHOULDER_P:
              period: 10 # [s]
              amplitude: 0.2 # rad
        - time: 3.0
          posture:
            NECK_Y: -0.01
            NECK_P: -0.05
            L_SHOULDER_P: -0.21
            L_ELBOW_P: -1.037
            R_ELBOW_P: -1.115
            R_SHOULDER_P: -0.383
        - time: 5.0
          posture:
            L_SHOULDER_R: 0.703
            R_SHOULDER_R: -0.851
            shake:
            L_SHOULDER_R:
            R_SHOULDER_R:
              period: 10 # [s]
              amplitude: 0.2 # rad
        - time: 5.0
          posture:
            NECK_Y: -0.553
            NECK_P: -0.333
            R_SHOULDER_P: -1.267
            R_SHOULDER_R: -0.193
            R_SHOULDER_Y: 0.78
            R_ELBOW_P: -0.548
            L_SHOULDER_R: 0.176
            shake:
            NECK_P:
              period: 10 # [s]
              amplitude: 0.2 # rad           


  Dance::Demo::FSM:
    base: Meta
    ResetPostures: false
    transitions:
      - [Salutations, OK, Dance::Seq4::ConditionBaseMovement::withPubSub, Strict]

  Dance::Demo::StabilizedFSM:
    base: Parallel
    states: [Stabilizer::Standing, Dance::Demo::FSM]

  Dance::Seq4::ConditionBaseMovement:
    base: Meta
    ResetPostures: false
    transitions:
      - [Dance::ConditionBaseMovement, Seq0, TouchHead, Auto]
      - [Dance::ConditionBaseMovement, Seq1, DrawCircleRightHand, Auto]
      - [Dance::ConditionBaseMovement, Seq2, RaiseRightHand_v2, Auto]
      - [Dance::ConditionBaseMovement, Seq3, TouchHead_L, Auto]
      - [Dance::ConditionBaseMovement, Seq4, RaiseLeftHand, Auto]
      - [Dance::ConditionBaseMovement, Seq5, DrawCircleLeftHand, Auto]
      - [Dance::ConditionBaseMovement, Seq6, LeftHeadTilt, Auto]
      - [Dance::ConditionBaseMovement, Seq7, RightHeadTilt, Auto]
      - [TouchHead, OK, HalfSitting, Auto]
      - [DrawCircleRightHand, OK, HalfSitting, Auto]
      - [RaiseRightHand_v2, OK, HalfSitting, Auto]
      - [TouchHead_L, OK, HalfSitting, Auto]
      - [RaiseLeftHand, OK, HalfSitting, Auto]
      - [DrawCircleLeftHand, OK, HalfSitting, Auto]
      - [LeftHeadTilt, OK, HalfSitting, Auto]
      - [RightHeadTilt, OK, HalfSitting, Auto]
      - [HalfSitting, OK, Dance::ConditionBaseMovement, Auto]



  Dance::Seq4::ConditionBaseMovement::withPubSub:
    base: Parallel
    states: [RosSubscriber, LookAtAudience, Dance::Seq4::ConditionBaseMovement]

transitions:
  - [Dance::Demo::StabilizedFSM, OK, Dance::Demo::StabilizedFSM, Strict]

init: Dance::Demo::StabilizedFSM

ObserverPipelines:
- name: "MainPipeline"
  observers:
    - type: Encoder
    - type: Attitude
    - type: KinematicInertial
